<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagrama de Máquinas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100">
  
 <!-- Header -->
<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="flex items-center space-x-2">
      <img src="https://images.squarespace-cdn.com/content/v1/58a36221d482e9bca4af6eac/34694fc3-6f92-4054-8a58-3776436c00dc/IMG_9869+2.PNG" alt="Logo" class="h-10 w-auto" />
      <span class="text-xl font-bold text-red-600">SIMio</span>
      <span id="rolVisual" class="text-sm text-gray-500 italic ml-4">(Rol: <span id="nombreRol">cargando...</span>)</span>
    </a>

    <!-- Menú desktop -->
    <nav class="hidden md:flex space-x-6 text-sm font-medium">
      <a href="index.html" class="text-gray-700 hover:text-red-600">Home</a>
      <a href="inventario.html" class="text-gray-700 hover:text-red-600">Inventario</a>
      <a href="mantenimiento.html" class="text-gray-700 hover:text-red-600">Mantenimiento</a>
      <a href="maquinas.html" class="text-red-600 font-bold">Diagrama de Máquinas</a>
      <a href="info.html" title="Ver documentación" class="text-gray-500 hover:text-red-600"> ℹ️ </a>
    </nav>

    <!-- Botón hamburguesa -->
    <button id="menuToggle" class="md:hidden text-gray-700 focus:outline-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round"
          stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>

  <!-- Menú móvil -->
  <div id="mobileMenu" class="md:hidden hidden px-4 pb-4">
    <a href="index.html" class="block py-2 text-gray-700 hover:text-red-600">Home</a>
    <a href="inventario.html" class="block py-2 text-gray-700 hover:text-red-600">Inventario</a>
    <a href="mantenimiento.html" class="block py-2 text-gray-700 hover:text-red-600">Mantenimiento</a>
    <a href="maquinas.html" class="block py-2 text-gray-700 hover:text-red-600">Diagrama de Máquinas</a>
    <a href="info.html" class="block py-2 text-gray-700 hover:text-red-600"> ℹ️ </a>
  </div>
</header>

  <main class="max-w-7xl mx-auto mt-10 px-4">
    <h1 class="text-xl font-bold mb-4">📍 Diagrama de Máquinas</h1>
    <div id="map" class="w-full h-[80vh] rounded shadow"></div>
  </main>

  <footer class="bg-gray-600 text-gray-200 text-center py-6 mt-10 text-sm">
    <div class="max-w-4xl mx-auto px-4 flex flex-col items-center space-y-2">
      <p>© 2025 <strong><a href="https://geo-way.github.io/GeoWay.io/index.html" class="hover:underline">GEOWAY</a></strong>, Technology-Based Initiative – IBT. All rights reserved.</p>
      <img src="https://geo-way.github.io/GeoWay.io/images/Logo5.png" alt="GEOWAY Logo" class="h-8 md:h-6 w-auto">
    </div>
  </footer>

  <script>
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -1,
      maxZoom: 2,
      zoomControl: true
    });

    const bounds = [[0, 0], [1000, 1500]];
    const image = L.imageOverlay('img/layout_horizontal.png', bounds).addTo(map);
    map.setView([600, 750], 0);

    const estadoColores = {
      "Reparado": "green",
      "Pendiente": "yellow",
      "En seguimiento": "orange",
      "Fuera de servicio": "red"
    };

    const maquinas = [
      { nombre: "PISTOLA CUADROS", coords: [892, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_CUADROS.pdf" },
      { nombre: "PISTOLA SEMIFLEX", coords: [822, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_SEMIFLEX.pdf" },
      { nombre: "PISTOLA CERRAR", coords: [750, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_CERRAR.pdf" },
      { nombre: "EMBALADORA 2 TK381", coords: [120, 390], manual: "https://kalixxe.github.io/Manuales/EMBALADORA_2_TK381.pdf" },
      { nombre: "BOX TK386", coords: [690, 170], manual: "https://kalixxe.github.io/Manuales/BOX_TK386.pdf" },
      { nombre: "PORTER", coords: [770, 575], manual: "https://kalixxe.github.io/Manuales/PORTER.pdf" },
      { nombre: "CORTE BOBINAS", coords: [900, 655], manual: "https://kalixxe.github.io/Manuales/CORTE_BOBINAS.pdf" },
      { nombre: "CORTE PANTASOTA", coords: [770, 650], manual: "https://kalixxe.github.io/Manuales/CORTE_PANTASOTA.pdf" },
      { nombre: "QUILTING HC 3500 BANDAS1", coords: [800, 420], manual: "https://kalixxe.github.io/Manuales/QUILTING_HC_3500_BANDAS1.pdf" },
      { nombre: "QUILTING HC 3500 BANDAS2", coords: [800, 335], manual: "https://kalixxe.github.io/Manuales/QUILTING_HC_3500_BANDAS2.pdf" },
      { nombre: "QUILTIADORA 2", coords: [210, 888], manual: "https://kalixxe.github.io/Manuales/QUILTIADORA_2.pdf" },
      { nombre: "QUILTIADORA 3", coords: [300, 888], manual: "https://kalixxe.github.io/Manuales/QUILTIADORA_3.pdf" },
      { nombre: "EMBALADORA 1", coords: [200, 390], manual: "https://kalixxe.github.io/Manuales/EMBALADORA_1.pdf" },
      { nombre: "ZONA POKCKET LR-PS-LINE 19F09", coords: [380, 1120], manual: "https://kalixxe.github.io/Manuales/ZONA_POKCKET_LR-PS-LINE_19F09.pdf" },
      { nombre: "ZONA BONNEL", coords: [380, 1250], manual: "https://kalixxe.github.io/Manuales/ZONA_BONNEL.pdf" },
      { nombre: "ZONA TAPA-TAPA TK900", coords: [400, 888], manual: "https://kalixxe.github.io/Manuales/ZONA_TAPA-TAPA_TK900.pdf" },
      { nombre: "COSTURA", coords: [170, 760], manual: "https://kalixxe.github.io/Manuales/COSTURA.pdf" },
      { nombre: "QUILTIADORA 1", coords: [115, 888], manual: "https://github.com/Kalixxe/Manuales/blob/main/LEFT%20HAND%20OVERLOCK%20HEAD.pdf" },
      { nombre: "DAMAGE", coords: [170, 680], manual: "https://kalixxe.github.io/Manuales/DAMAGE.pdf" },
      { nombre: "CERRADORA 5", coords: [255, 548], manual: "https://kalixxe.github.io/Manuales/CERRADORA_5.pdf" },
      { nombre: "CERRADORA 4", coords: [290, 548], manual: "https://kalixxe.github.io/Manuales/CERRADORA_4.pdf" },
      { nombre: "CERRADORA 3", coords: [330, 548], manual: "https://kalixxe.github.io/Manuales/CERRADORA_3.pdf" },
      { nombre: "CERRADORA 2", coords: [370, 548], manual: "https://github.com/Kalixxe/Manuales/blob/main/RIGHT%20HAND%20OVERLOCK%20HEAD.pdf" },
      { nombre: "TK050", coords: [255, 480], manual: "https://kalixxe.github.io/Manuales/TK050.pdf" },
      { nombre: "CERRADORA 1", coords: [515, 390], manual: "https://github.com/Kalixxe/Manuales/blob/main/LEFT%20HAND%20OVERLOCK%20HEAD.pdf" },
      { nombre: "PRENSA PILLOW TK 19F09", coords: [280, 345], manual: "https://kalixxe.github.io/Manuales/PRENSA_PILLOW_TK_19F09.pdf" },
      { nombre: "ENCOLADORA 1", coords: [510, 645], manual: "https://kalixxe.github.io/Manuales/ENCOLADORA_1.pdf" },
      { nombre: "ENCOLADORA 2", coords: [510, 810], manual: "https://kalixxe.github.io/Manuales/ENCOLADORA_2.pdf" },
      { nombre: "BANDAS 2", coords: [690, 390], manual1: "https://github.com/Kalixxe/Manuales/blob/main/LEFT%20HAND%20OVERLOCK%20HEAD.pdf",
                                                manual2: "https://github.com/Kalixxe/Manuales/blob/main/LEFT%20HAND%20OVERLOCK%20HEAD.pdf}
    ];

    async function obtenerEstado(maquina) {
      try {
        const res = await fetch("https://sim-io.onrender.com/api/mantenimiento");
        const data = await res.json();
        const ult = data.find(d => d.maquina?.toLowerCase() === maquina.toLowerCase());
        return { estado: ult?.estadoaccion || "Reparado", fecha: ult?.fecha?.split("T")[0] || "Sin registro" };
      } catch {
        return { estado: "Reparado", fecha: "Sin datos" };
      }
    }

    maquinas.forEach(async ({ nombre, coords, manual }) => {
      const { estado, fecha } = await obtenerEstado(nombre);
      const color = estadoColores[estado] || "gray";
      const marker = L.circleMarker(coords, {
        radius: 8,
        color,
        fillColor: color,
        fillOpacity: 1
      }).addTo(map);

      marker.bindPopup(`
        <div class="text-sm">
          <p class="font-bold">🔧 ${nombre}</p>
          <p class="text-xs">📅 Último mantenimiento: ${fecha}</p>
          <a href="${manual}" target="_blank" class="text-blue-600 underline block mt-1">📥 Descargar manual</a>
          <a href="mantenimiento.html?maquina=${encodeURIComponent(nombre)}" class="text-blue-600 underline block">🔧 Ver mantenimientos</a>
        </div>
      `);
    });

    const legend = L.control({ position: 'topright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'bg-white p-2 text-xs rounded shadow');
      div.innerHTML = `
        <strong>MANTENIMIENTO:</strong><br>
        <span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span>En funcionamiento<br>
        <span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-1"></span>Programado<br>
        <span class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-1"></span>En seguimiento<br>
        <span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span>Fuera de servicio
      `;
      return div;
    };
    legend.addTo(map);

L.control.attribution({
  position: 'bottomleft',
  prefix: `
    <span style="display: inline-flex; align-items: center; gap: 6px; font: 11px/1.5 'Helvetica Neue', Arial, Helvetica, sans-serif; color: #333;">
      <a href="https://geo-way.github.io/GeoWay.io/index.html" target="_blank" style="color: inherit; text-decoration: none;">
        Powered by 
      </a>
      <img src="https://geo-way.github.io/GeoWay.io/images/Logo5.png" alt="GEOWAY" style="height: 14px; vertical-align: middle; filter: brightness(0);">
    </span>
  `
}).addTo(map);

  </script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const spanRol = document.getElementById("nombreRol");
    if (spanRol) {
      const role = localStorage.getItem("role") || "viewer";
      spanRol.textContent = role;
    }
  });
</script>
<!-- funcion para la hamburgesa de Menú para móviles -->
<script>
  const menuToggle = document.getElementById("menuToggle");
  const mobileMenu = document.getElementById("mobileMenu");

  menuToggle.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
  });
  
</script>
  
</body>
</html>
